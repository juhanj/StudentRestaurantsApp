<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SDSCA - Map</title>
    <meta name="viewport" content="width=device-width">
    <link rel="icon" href="favicon-anim.gif" type="image/gif">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="css/main.css">
    <script src="./js/main.js"></script>

    <style>
        .material-icons {
            font-size: 6em;
        }

        .map {
            height: 100%;
            width: 100%;
            position: absolute;
            padding: 0;
            margin: 0;
        }
    </style>
</head>
<body>

<div id="googleMap" class="map"></div>
<div id="header">
    <a href="list.php"><i class="material-icons">menu</i></a>
</div>

<script>
    let map,
        marker,
        markers,
        defaultLocation,
        icon_user,
        icon_restaurant,
        icon_closest,
        mapProp,
        locations,
        obj,
        infoWindow,
        geolocation,
        geolocobj,
        user,
        closest,
        lat,
        lng;

    function myMap() {

        defaultLocation = new google.maps.LatLng(62.60393, 29.74413);
        //var myLocation = new google.maps.LatLng(62.598567, 29.745048);
        //var restaurant = new google.maps.LatLng(62.603933, 29.744134);
        //var closest = new google.maps.LatLng(62.597944, 29.743766);

        closest = [];
        //marker ;

        icon_user = {
            url: "https://maps.google.com/mapfiles/ms/micons/man.png",
        };
        icon_restaurant = {
            url: "https://maps.google.com/mapfiles/ms/micons/red-dot.png",
        };
        icon_closest = {
            url: "https://maps.google.com/mapfiles/ms/micons/blue-dot.png",
        };

        mapProp = {
            center: defaultLocation,
            zoom: 14,
            fullscreenControl: false,
            streetViewControl: false,
            zoomControl: false,
            mapTypeControl: false
        };

        locations = getCookie('restaurants');
        obj = JSON.parse(locations);

        map = new google.maps.Map(document.getElementById("googleMap"), mapProp);
        map.controls[google.maps.ControlPosition.TOP_LEFT].push(header);

        markers = [];
        infoWindow = new google.maps.InfoWindow({
            //maxWidth: 200,
            content: ""
        });

        geolocation = getCookie('location');
        geolocobj = JSON.parse(geolocation);

        if (geolocobj == null) {
            console.log("Location not found");
        } else {
            console.log("Location found");
            navigator.geolocation.watchPosition(function (pos) {
                var lat = pos.coords.latitude,
                    lng = pos.coords.longitude;
                coords = new google.maps.LatLng(lat, lng);
                user = new google.maps.Marker({
                    info:
                        "<b>My Location</b>",
                    icon: "https://maps.google.com/mapfiles/ms/micons/man.png",
                    title: 'My Location'
                });


                closest = markers[getClosest(lat, lng)];
                console.log(closest);

                user.setPosition(coords);
                user.setMap(map);
                map.setCenter(coords);

                /*
                if (user.Position == lat && user.Position == lng) {
                  console.log("t");
                }
                */

            }, error);

        }

        updateMarkers();
        drawMarkers();

    }

    function getClosest(lat, lng) {
        var R = 6371; // radius of earth in km
        var distances = [];
        var closesti = -1;
        for (i = 0; i < markers.length; i++) {
            var mlat = markers[i].position.lat();
            var mlng = markers[i].position.lng();
            var dLat = rad(mlat - lat);
            var dLong = rad(mlng - lng);
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(rad(lat)) * Math.cos(rad(lat)) * Math.sin(dLong / 2) * Math.sin(dLong / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var d = R * c;
            distances[i] = d;
            if (closesti == -1 || d < distances[closesti]) {
                closesti = i;
            }
        }
        return closesti;
    }

    function rad(x) {
        return x * Math.PI / 180;
    }

    function error(err) {
        alert('ERROR(' + err.code + '): ' + err.message);
    }

    function updateMarkers() {
        for (i = 0; i < obj.length; i++) {
            var marker = new google.maps.Marker({
                position: {lat: obj[i].loc.lat, lng: obj[i].loc.long},
                map: map,
                info:
                "<b>" + obj[i].name + "</b><br>" +
                "Location: " + obj[i].loc.lat + ", " + obj[i].loc.long + "<br>" +
                "Address: " + obj[i].addr + "<br>" +
                "<a href= " + obj[i].url + ">Website</a>"
            });

            addInfoWindow(infoWindow, marker, locations[i][0]);
            markers.push(marker);

        }

    }

    function drawMarkers() {
        for (i = 0; i < markers.length; i++) {
            if (markers[i] == closest) {
                markers[i].setIcon(icon_closest);
            } else {
                markers[i].setIcon(icon_restaurant);
            }
            markers[i].setMap(map);
        }
    }

    function addInfoWindow(infoWindow, marker, message) {
        google.maps.event.addListener(marker, 'click', function () {
            infoWindow.setContent(marker.info);
            infoWindow.open(map, marker);
        });
    }

    function drawRoute() {

    }

</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBQyXJKLhKIYX0XeSZ8TvNJWxr_vOuZf8s&callback=myMap">
</script>

</body>
